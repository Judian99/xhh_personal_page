<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>ğŸ“· ç¦å·æ‘„å½±æ‰«è¡— - éšæœºé€‰ç‚¹å™¨</title>
    <style>
        html, body, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        
        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 999;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .panel-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title {
            font-size: 14px;
            color: #666;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }

        /* å¤é€‰æ¡†ç½‘æ ¼ */
        .district-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .district-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .district-item input {
            margin-right: 4px;
        }

        /* ä¸‹æ‹‰æ¡†å’ŒæŒ‰é’® */
        select, button {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            font-size: 14px;
        }

        button {
            background-color: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #1d4ed8;
        }

        button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }

        /* ç»“æœå±•ç¤ºåŒº */
        .result-box {
            margin-top: 10px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 4px;
            border-left: 4px solid #2563eb;
            display: none; /* é»˜è®¤éšè— */
        }

        .result-title {
            font-weight: bold;
            color: #1e40af;
            font-size: 13px;
        }
        .result-addr {
            margin-top: 4px;
            font-size: 14px;
            color: #333;
        }

        .loading-text {
            color: #666;
            font-size: 12px;
            text-align: center;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .control-panel {
                width: calc(100% - 2rem);
                top: auto;
                bottom: 2rem;
                max-height: 60vh;
            }
        }
    </style>
</head>
<body>

<div id="container"></div>

<div class="control-panel">
    <div class="panel-header">
        <span>ğŸ“¸ æ‰«è¡—éšæœºé€‰ç‚¹</span>
    </div>

    <div class="section-title">1. é€‰æ‹©åŒºåŸŸ (ç¦å·)</div>
    <div id="district-list" class="district-grid">
        <div class="loading-text">æ­£åœ¨åŠ è½½è¡Œæ”¿åŒºæ•°æ®...</div>
    </div>

    <div class="section-title">2. è·ç¦»é™åˆ¶ (ç¦»æˆ‘å¤šè¿œ)</div>
    <select id="distance-select">
        <option value="-1">æ— é™åˆ¶ (å…¨åŸéšæœº)</option>
        <option value="1000">1 å…¬é‡Œå†… (æ­¥è¡Œåœˆ)</option>
        <option value="3000">3 å…¬é‡Œå†… (éª‘è¡Œåœˆ)</option>
        <option value="5000">5 å…¬é‡Œå†…</option>
        <option value="10000">10 å…¬é‡Œå†…</option>
    </select>

    <button id="locate-btn" onclick="startRandomSelection()">ğŸ² å¼€å§‹éšæœºé€‰ç‚¹</button>

    <div id="result-box" class="result-box">
        <div class="result-title">æ¨èåœ°ç‚¹ï¼š</div>
        <div class="result-addr" id="result-address">...</div>
        <div style="font-size:12px; color:#666; margin-top:5px;">è·æ‚¨çº¦ <span id="result-distance">-</span> ç±³</div>
    </div>
</div>

<script type="text/javascript">
    // âš ï¸âš ï¸âš ï¸ è¯·å…ˆé…ç½®å®‰å…¨å¯†é’¥ (å¿…é¡»åœ¨åŠ è½½ Key ä¹‹å‰)
    window._AMapSecurityConfig = {
        securityJsCode: '65ff073786c2bf49d673e2e8feb6b5f0', // ä¾‹å¦‚ 'a1b2c3d4e5...'
    }
</script>

<!-- åŠ è½½æ’ä»¶ï¼šDistrictSearch(è¡Œæ”¿åŒº), GeometryUtil(å‡ ä½•è®¡ç®—), Geolocation(å®šä½), Geocoder(åœ°å€è§£æ) -->
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=43ac1e3a18e5e369343f375d3d014c4e&plugin=AMap.DistrictSearch,AMap.GeometryUtil,AMap.Geolocation,AMap.Geocoder,AMap.ToolBar,AMap.Scale"></script>

<script type="text/javascript">
    // å…¨å±€å˜é‡
    var map;
    var userLocation = null; // ç”¨æˆ·å½“å‰ä½ç½®
    var userMarker = null;   // ç”¨æˆ·ä½ç½®æ ‡è®°
    var targetMarker = null; // éšæœºç›®æ ‡æ ‡è®°
    var districtPolygons = {}; // ç¼“å­˜å„åŒºçš„è¾¹ç•Œæ•°æ® { 'é¼“æ¥¼åŒº': [PolygonObj, ...], ... }
    var loadedDistricts = [];  // å·²åŠ è½½çš„åŒºåˆ—è¡¨
    var isLocating = false;

    // åˆå§‹åŒ–
    if (typeof AMap !== 'undefined') {
        initMap();
    } else {
        alert("åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key é…ç½®");
    }

    function initMap() {
        map = new AMap.Map('container', {
            zoom: 11,
            center: [119.306239, 26.075302], // ç¦å·ä¸­å¿ƒ
            viewMode: '2D',
            resizeEnable: true
        });

        map.addControl(new AMap.Scale());
        map.addControl(new AMap.ToolBar({position: {top: '110px', right: '10px'}}));

        // 1. åˆå§‹åŒ–ç”¨æˆ·å®šä½
        var geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,
            timeout: 10000,
            buttonOffset: new AMap.Pixel(10, 20),
            zoomToAccuracy: false, // åˆ«è‡ªåŠ¨ç¼©æ”¾ï¼Œä»¥å…å¹²æ‰°è§†é‡
            buttonPosition: 'RB'
        });
        map.addControl(geolocation);
        
        // ç›‘å¬å®šä½ç»“æœï¼Œæ›´æ–°å…¨å±€å˜é‡
        geolocation.on('complete', function(data) {
            userLocation = data.position;
            console.log("ç”¨æˆ·ä½ç½®æ›´æ–°:", userLocation);
        });
        geolocation.on('error', function(err) {
            console.warn("å®šä½å¤±è´¥ (å¯èƒ½éœ€è¦HTTPSç¯å¢ƒ):", err);
        });
        
        // è‡ªåŠ¨è§¦å‘ä¸€æ¬¡å®šä½
        geolocation.getCurrentPosition();

        // 2. åŠ è½½ç¦å·è¡Œæ”¿åŒºæ•°æ®
        loadFuzhouDistricts();
    }

    // åŠ è½½è¡Œæ”¿åŒºæ•°æ®
    function loadFuzhouDistricts() {
        var districtSearch = new AMap.DistrictSearch({
            level: 'city',
            subdistrict: 1, // è¿”å›ä¸‹ä¸€çº§è¡Œæ”¿åŒº
            extensions: 'all' // è¿”å›è¡Œæ”¿åŒºè¾¹ç•Œåæ ‡
        });

        // æŸ¥è¯¢ç¦å·å¸‚ (adcode: 350100)
        districtSearch.search('350100', function(status, result) {
            if(status === 'complete') {
                var subDistricts = result.districtList[0].districtList;
                var listHtml = '';
                
                // éå†ä¸‹çº§åŒºå¿
                subDistricts.forEach(function(district) {
                    var name = district.name;
                    var adcode = district.adcode;
                    
                    // è¿‡æ»¤æ‰ä¸éœ€è¦çš„åŒºåŸŸï¼ˆæ ¹æ®éœ€è¦å¯é€‰ï¼Œè¿™é‡Œé»˜è®¤å…¨éƒ¨æ˜¾ç¤ºï¼‰
                    loadedDistricts.push({ name: name, adcode: adcode });
                    
                    listHtml += `
                        <label class="district-item">
                            <input type="checkbox" name="district" value="${name}" checked>
                            ${name}
                        </label>
                    `;

                    // å¼‚æ­¥è·å–æ¯ä¸ªåŒºçš„è¯¦ç»†è¾¹ç•Œï¼ˆå› ä¸º search('ç¦å·å¸‚') åªè¿”å›äº†åå­—ï¼Œæ²¡è¿”å›è¯¦ç»†å­è¾¹ç•Œï¼‰
                    loadDistrictBoundaries(name);
                });

                document.getElementById('district-list').innerHTML = listHtml;
            }
        });
    }

    // è·å–å•ä¸ªåŒºçš„è¾¹ç•Œå¹¶ç¼“å­˜
    function loadDistrictBoundaries(name) {
        var opts = {
            subdistrict: 0, 
            extensions: 'all', 
            level: 'district'
        };
        var district = new AMap.DistrictSearch(opts);
        
        district.search('ç¦å·å¸‚' + name, function(status, result) {
            if (status === 'complete') {
                var bounds = result.districtList[0].boundaries;
                if (bounds) {
                    // ç¼“å­˜è¾¹ç•Œæ•°æ®ï¼šbounds æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«å¤šä¸ªç»çº¬åº¦æ•°ç»„ï¼ˆå¤„ç†é£åœ°/å²›å±¿ï¼‰
                    districtPolygons[name] = bounds.map(path => path);
                }
            }
        });
    }

    // æ ¸å¿ƒé€»è¾‘ï¼šå¼€å§‹éšæœºé€‰ç‚¹
    async function startRandomSelection() {
        var btn = document.getElementById('locate-btn');
        var resultBox = document.getElementById('result-box');
        
        // 1. è·å–é€‰ä¸­çš„åŒºåŸŸ
        var checkboxes = document.querySelectorAll('input[name="district"]:checked');
        var selectedDistricts = Array.from(checkboxes).map(cb => cb.value);

        if (selectedDistricts.length === 0) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¡Œæ”¿åŒºï¼");
            return;
        }

        // 2. è·å–è·ç¦»é™åˆ¶
        var distanceLimit = parseInt(document.getElementById('distance-select').value);
        
        // å¦‚æœæœ‰è·ç¦»é™åˆ¶ï¼Œå¿…é¡»å…ˆæœ‰ç”¨æˆ·åæ ‡
        if (distanceLimit > 0 && !userLocation) {
            alert("éœ€è¦è·å–æ‚¨çš„ä½ç½®æ‰èƒ½è®¡ç®—è·ç¦»ã€‚\nè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦å…è®¸å®šä½ï¼Œæˆ–åˆ‡æ¢åˆ°'æ— é™åˆ¶'æ¨¡å¼ã€‚");
            return;
        }

        btn.disabled = true;
        btn.innerText = "æ­£åœ¨å¯»æ‰¾åˆé€‚åœ°ç‚¹...";
        resultBox.style.display = 'none';
        
        // æ¸…é™¤æ—§æ ‡è®°
        if (targetMarker) map.remove(targetMarker);

        // 3. å°è¯•ç”Ÿæˆç‚¹ (é‡è¯•æœºåˆ¶)
        // ä¸ºä»€ä¹ˆè¦é‡è¯•ï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨çŸ©å½¢èŒƒå›´å†…éšæœºç”Ÿæˆç‚¹ï¼Œå¯èƒ½è¿™ä¸ªç‚¹ä¸åœ¨å¤šè¾¹å½¢å†…(åœ¨è¾¹ç•Œå¤–)ï¼Œæˆ–è€…è¶…å‡ºè·ç¦»é™åˆ¶ã€‚
        var foundPoint = null;
        var maxAttempts = 100; // æœ€å¤§å°è¯•æ¬¡æ•°

        for (var i = 0; i < maxAttempts; i++) {
            // A. éšæœºé€‰ä¸€ä¸ªåŒº
            var randomDistrictName = selectedDistricts[Math.floor(Math.random() * selectedDistricts.length)];
            var boundaries = districtPolygons[randomDistrictName];
            
            if (!boundaries) continue; // æ•°æ®å¯èƒ½è¿˜æ²¡åŠ è½½å®Œ

            // B. åœ¨è¯¥åŒºå†…ç”Ÿæˆä¸€ä¸ªéšæœºç‚¹
            var point = generateRandomPointInBoundaries(boundaries);
            
            if (point) {
                // C. æ£€æŸ¥è·ç¦»é™åˆ¶
                if (distanceLimit > 0) {
                    var distance = AMap.GeometryUtil.distance(userLocation, point);
                    if (distance <= distanceLimit) {
                        foundPoint = { pos: point, dist: distance };
                        break; // æ‰¾åˆ°äº†ï¼
                    }
                } else {
                    foundPoint = { pos: point, dist: -1 };
                    break; // æ‰¾åˆ°äº†ï¼(æ— è·ç¦»é™åˆ¶)
                }
            }
        }

        btn.disabled = false;
        btn.innerText = "ğŸ² å¼€å§‹éšæœºé€‰ç‚¹";

        if (foundPoint) {
            showResult(foundPoint);
        } else {
            alert("æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åœ°ç‚¹ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. è·ç¦»é™åˆ¶å¤ªå°ï¼Œæ‚¨æ‰€åœ¨çš„åŒºåŸŸä¸åœ¨æ‰€é€‰è¡Œæ”¿åŒºå†…ã€‚\n2. è¯·å°è¯•å¢åŠ è·ç¦»æˆ–é€‰æ‹©æ›´å¤šåŒºåŸŸã€‚");
        }
    }

    // åœ¨å¤šè¾¹å½¢é›†åˆä¸­ç”Ÿæˆéšæœºç‚¹
    function generateRandomPointInBoundaries(boundaries) {
        // 1. éšæœºé€‰ä¸€ä¸ªå¤šè¾¹å½¢å— (æœ‰çš„åŒºæœ‰é£åœ°ï¼Œæ˜¯å¤šä¸ªå¤šè¾¹å½¢)
        var path = boundaries[Math.floor(Math.random() * boundaries.length)];
        
        // 2. è®¡ç®—è¯¥å¤šè¾¹å½¢çš„ Bounding Box (æœ€å°å¤–æ¥çŸ©å½¢)
        var minLng = 180, maxLng = 0, minLat = 90, maxLat = 0;
        path.forEach(p => {
            minLng = Math.min(minLng, p.lng);
            maxLng = Math.max(maxLng, p.lng);
            minLat = Math.min(minLat, p.lat);
            maxLat = Math.max(maxLat, p.lat);
        });

        // 3. åœ¨çŸ©å½¢å†…éšæœºç”Ÿæˆä¸€ä¸ªåæ ‡
        var randomLng = Math.random() * (maxLng - minLng) + minLng;
        var randomLat = Math.random() * (maxLat - minLat) + minLat;
        var randomPoint = new AMap.LngLat(randomLng, randomLat);

        // 4. å…³é”®ï¼šåˆ¤æ–­ç‚¹æ˜¯å¦çœŸçš„åœ¨å¤šè¾¹å½¢å†…éƒ¨ (ä½¿ç”¨ GeometryUtil)
        var isInside = AMap.GeometryUtil.isPointInRing(randomPoint, path);

        if (isInside) {
            return randomPoint;
        } else {
            return null; // å¤±è´¥ï¼Œéœ€è¦åœ¨å¤–å±‚å¾ªç¯é‡è¯•
        }
    }

    // å±•ç¤ºç»“æœ
    function showResult(data) {
        var point = data.pos;
        var dist = data.dist;

        // 1. æ·»åŠ æ ‡è®°
        targetMarker = new AMap.Marker({
            position: point,
            animation: 'AMAP_ANIMATION_DROP',
            title: 'æ‰«è¡—ç›®çš„åœ°'
        });
        map.add(targetMarker);
        
        // 2. è§†é‡è‡ªé€‚åº”
        if (userLocation && dist > 0) {
            map.setFitView([userMarker, targetMarker]); // ç¼©æ”¾åˆ°èƒ½çœ‹åˆ°ä¸¤ç‚¹
        } else {
            map.setCenter(point);
            map.setZoom(15);
        }

        // 3. é€†åœ°ç†ç¼–ç  (è·å–åœ°å€)
        var geocoder = new AMap.Geocoder();
        geocoder.getAddress(point, function(status, result) {
            var addressText = "æœªçŸ¥åœ°ç‚¹";
            if (status === 'complete' && result.regeocode) {
                addressText = result.regeocode.formattedAddress;
            }
            
            // æ›´æ–° UI
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('result-address').innerText = addressText;
            document.getElementById('result-distance').innerText = dist > 0 ? Math.round(dist) : "æœªçŸ¥";
        });
    }
</script>
</body>
</html>
