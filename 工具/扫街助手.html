<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>ğŸ“· ç¦å·æ‘„å½±æ‰«è¡— - éšæœºé€‰ç‚¹å™¨</title>
    <style>
        html, body, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        
        .control-panel {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 999;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .panel-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title {
            font-size: 14px;
            color: #666;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }

        .district-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .district-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .district-item input {
            margin-right: 4px;
        }

        select, button {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            font-size: 14px;
        }

        button {
            background-color: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #1d4ed8;
        }

        button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .result-box {
            margin-top: 10px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 4px;
            border-left: 4px solid #2563eb;
            display: none;
        }

        .result-title {
            font-weight: bold;
            color: #1e40af;
            font-size: 13px;
        }
        .result-addr {
            margin-top: 4px;
            font-size: 14px;
            color: #333;
        }

        .loading-text {
            color: #666;
            font-size: 12px;
            text-align: center;
            padding: 10px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-badge {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-loading { background-color: #fbbf24; }
        .status-ready { background-color: #10b981; }
        
        @media (max-width: 480px) {
            .control-panel {
                width: calc(100% - 2rem);
                top: auto;
                bottom: 2rem;
                max-height: 60vh;
            }
        }
    </style>
</head>
<body>

<div id="container"></div>

<div class="control-panel">
    <div class="panel-header">
        <span>ğŸ“¸ æ‰«è¡—éšæœºé€‰ç‚¹</span>
        <span style="font-size:12px; font-weight:normal; color:#666;">
            <span id="data-status-dot" class="status-badge status-loading"></span>
            <span id="data-status-text">æ•°æ®åŠ è½½ä¸­...</span>
        </span>
    </div>

    <div class="section-title">1. é€‰æ‹©åŒºåŸŸ (ç¦å·)</div>
    <div id="district-list" class="district-grid">
        <div class="loading-text">æ­£åœ¨è·å–è¡Œæ”¿åŒºåˆ’...</div>
    </div>

    <div class="section-title">2. è·ç¦»é™åˆ¶ (ç¦»æˆ‘å¤šè¿œ)</div>
    <select id="distance-select">
        <option value="-1">æ— é™åˆ¶ (å…¨åŸéšæœº)</option>
        <option value="1000">1 å…¬é‡Œå†… (æ­¥è¡Œåœˆ)</option>
        <option value="3000">3 å…¬é‡Œå†… (éª‘è¡Œåœˆ)</option>
        <option value="5000">5 å…¬é‡Œå†…</option>
        <option value="10000">10 å…¬é‡Œå†…</option>
    </select>

    <!-- é»˜è®¤ç¦ç”¨ï¼Œç­‰å¾…æ•°æ®åŠ è½½ -->
    <button id="locate-btn" disabled onclick="startRandomSelection()">â³ ç­‰å¾…åœ°å›¾æ•°æ®...</button>

    <div id="result-box" class="result-box">
        <div class="result-title">æ¨èåœ°ç‚¹ï¼š</div>
        <div class="result-addr" id="result-address">...</div>
        <div style="font-size:12px; color:#666; margin-top:5px;">è·æ‚¨çº¦ <span id="result-distance">-</span> ç±³</div>
    </div>
</div>

<script type="text/javascript">
    // âš ï¸âš ï¸âš ï¸ è¯·å…ˆé…ç½®å®‰å…¨å¯†é’¥ (å¿…é¡»åœ¨åŠ è½½ Key ä¹‹å‰)
    window._AMapSecurityConfig = {
        securityJsCode: '65ff073786c2bf49d673e2e8feb6b5f0', // ä¾‹å¦‚ 'a1b2c3d4e5...'
    }
</script>

<!-- åŠ è½½æ’ä»¶ -->
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=43ac1e3a18e5e369343f375d3d014c4e&plugin=AMap.DistrictSearch,AMap.GeometryUtil,AMap.Geolocation,AMap.Geocoder,AMap.ToolBar,AMap.Scale"></script>

<script type="text/javascript">
    // å…¨å±€å˜é‡
    var map;
    var userLocation = null; 
    var userMarker = null;
    var targetMarker = null;
    var districtPolygons = {}; // ç¼“å­˜è¾¹ç•Œæ•°æ®
    var totalDistrictsToLoad = 0;
    var loadedDistrictsCount = 0;

    // åˆå§‹åŒ–
    if (typeof AMap !== 'undefined') {
        initMap();
    } else {
        alert("åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key é…ç½®");
    }

    function initMap() {
        map = new AMap.Map('container', {
            zoom: 11,
            center: [119.306239, 26.075302], 
            viewMode: '2D',
            resizeEnable: true
        });

        map.addControl(new AMap.Scale());
        map.addControl(new AMap.ToolBar({position: {top: '110px', right: '10px'}}));

        // 1. å®šä½
        var geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,
            timeout: 10000,
            buttonOffset: new AMap.Pixel(10, 20),
            zoomToAccuracy: false,
            buttonPosition: 'RB'
        });
        map.addControl(geolocation);
        
        geolocation.on('complete', function(data) {
            userLocation = data.position;
            console.log("ç”¨æˆ·ä½ç½®æ›´æ–°:", userLocation);
            // å¦‚æœæ˜¯é¦–æ¬¡å®šä½æˆåŠŸï¼Œè‡ªåŠ¨æ›´æ–°ä¸€ä¸‹å½“å‰è·ç¦»æ¨¡å¼çš„çŠ¶æ€æç¤ºï¼ˆå¯é€‰ï¼‰
        });
        
        geolocation.getCurrentPosition();

        // 2. åŠ è½½è¡Œæ”¿åŒº
        loadFuzhouDistricts();
    }

    function loadFuzhouDistricts() {
        var districtSearch = new AMap.DistrictSearch({
            level: 'city',
            subdistrict: 1, 
            extensions: 'all' 
        });

        districtSearch.search('350100', function(status, result) {
            if(status === 'complete') {
                var subDistricts = result.districtList[0].districtList;
                var listHtml = '';
                
                totalDistrictsToLoad = subDistricts.length;
                
                subDistricts.forEach(function(district) {
                    var name = district.name;
                    // ç”ŸæˆHTML
                    listHtml += `
                        <label class="district-item">
                            <input type="checkbox" name="district" value="${name}" checked>
                            ${name}
                        </label>
                    `;
                    // å¹¶è¡ŒåŠ è½½è¾¹ç•Œ
                    loadDistrictBoundaries(name);
                });

                document.getElementById('district-list').innerHTML = listHtml;
            } else {
                document.getElementById('district-list').innerHTML = '<div class="loading-text">è·å–è¡Œæ”¿åŒºåˆ—è¡¨å¤±è´¥</div>';
            }
        });
    }

    function loadDistrictBoundaries(name) {
        var opts = {
            subdistrict: 0, 
            extensions: 'all', 
            level: 'district'
        };
        var district = new AMap.DistrictSearch(opts);
        
        district.search('ç¦å·å¸‚' + name, function(status, result) {
            if (status === 'complete' && result.districtList && result.districtList.length > 0) {
                var bounds = result.districtList[0].boundaries;
                if (bounds) {
                    // è¿‡æ»¤æ‰ç‚¹æ•°å¤ªå°‘çš„è·¯å¾„ï¼ˆå¯èƒ½æ˜¯å™ªéŸ³æˆ–æå°å²›å±¿ï¼‰ï¼Œæé«˜å‘½ä¸­ç‡
                    var validBounds = bounds.filter(path => path.length > 5);
                    if (validBounds.length > 0) {
                        districtPolygons[name] = validBounds;
                    }
                }
            }
            
            // æ›´æ–°è¿›åº¦
            loadedDistrictsCount++;
            checkDataReady();
        });
    }

    function checkDataReady() {
        if (loadedDistrictsCount >= totalDistrictsToLoad) {
            var btn = document.getElementById('locate-btn');
            btn.disabled = false;
            btn.innerText = "ğŸ² å¼€å§‹éšæœºé€‰ç‚¹";
            btn.style.backgroundColor = "#2563eb";
            
            document.getElementById('data-status-dot').className = "status-badge status-ready";
            document.getElementById('data-status-text').innerText = "æ•°æ®å·²å°±ç»ª";
        }
    }

    async function startRandomSelection() {
        var btn = document.getElementById('locate-btn');
        var resultBox = document.getElementById('result-box');
        
        var checkboxes = document.querySelectorAll('input[name="district"]:checked');
        var selectedDistricts = Array.from(checkboxes).map(cb => cb.value);

        if (selectedDistricts.length === 0) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¡Œæ”¿åŒºï¼");
            return;
        }

        var distanceLimit = parseInt(document.getElementById('distance-select').value);
        if (distanceLimit > 0 && !userLocation) {
            alert("éœ€è¦è·å–æ‚¨çš„ä½ç½®æ‰èƒ½è®¡ç®—è·ç¦»ã€‚\nè¯·æ£€æŸ¥å®šä½æƒé™ã€‚");
            return;
        }

        btn.disabled = true;
        btn.innerText = "æ­£åœ¨è®¡ç®—...";
        resultBox.style.display = 'none';
        if (targetMarker) map.remove(targetMarker);

        // ä½¿ç”¨ setTimeout è®© UI æœ‰æœºä¼šåˆ·æ–° "æ­£åœ¨è®¡ç®—..." æ–‡å­—
        setTimeout(() => {
            var foundPoint = findValidPoint(selectedDistricts, distanceLimit);
            
            btn.disabled = false;
            btn.innerText = "ğŸ² å¼€å§‹éšæœºé€‰ç‚¹";

            if (foundPoint) {
                showResult(foundPoint);
            } else {
                alert("æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åœ°ç‚¹ã€‚\n\nå»ºè®®ï¼š\n1. å¦‚æœå¼€å¯äº†è·ç¦»é™åˆ¶ï¼Œè¯·å°è¯•æ‰©å¤§èŒƒå›´ã€‚\n2. å¢åŠ é€‰æ‹©çš„è¡Œæ”¿åŒºæ•°é‡ã€‚");
            }
        }, 50);
    }

    function findValidPoint(selectedDistricts, distanceLimit) {
        // å¢åŠ æœ€å¤§å°è¯•æ¬¡æ•°åˆ° 500
        var maxAttempts = 500; 

        for (var i = 0; i < maxAttempts; i++) {
            // 1. éšæœºé€‰åŒº
            var randomDistrictName = selectedDistricts[Math.floor(Math.random() * selectedDistricts.length)];
            var boundaries = districtPolygons[randomDistrictName];
            
            if (!boundaries || boundaries.length === 0) continue;

            // 2. éšæœºé€‰è¯¥åŒºçš„ä¸€ä¸ªå¤šè¾¹å½¢å— (æƒé‡ä¼˜åŒ–ï¼šç¨å¾®å€¾å‘äºé•¿è·¯å¾„ï¼Œä½†ä¹Ÿä¿ç•™éšæœºæ€§)
            // è¿™é‡Œç®€å•éšæœºå³å¯ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ loadDistrictBoundaries å·²ç»è¿‡æ»¤äº†æå°çš„å™ªç‚¹
            var path = boundaries[Math.floor(Math.random() * boundaries.length)];
            
            // 3. åœ¨å¤šè¾¹å½¢çš„ Bounding Box å†…ç”Ÿæˆç‚¹
            var point = generatePointInPath(path);
            
            if (point) {
                // 4. è·ç¦»æ ¡éªŒ
                if (distanceLimit > 0) {
                    var distance = AMap.GeometryUtil.distance(userLocation, point);
                    if (distance <= distanceLimit) {
                        return { pos: point, dist: distance };
                    }
                } else {
                    return { pos: point, dist: -1 };
                }
            }
        }
        return null;
    }

    function generatePointInPath(path) {
        // è®¡ç®— BBox
        var minLng = 180, maxLng = 0, minLat = 90, maxLat = 0;
        
        // å¿«é€Ÿéå†è·å–è¾¹ç•Œ
        for(var i=0; i<path.length; i++) {
            var p = path[i];
            if(p.lng < minLng) minLng = p.lng;
            if(p.lng > maxLng) maxLng = p.lng;
            if(p.lat < minLat) minLat = p.lat;
            if(p.lat > maxLat) maxLat = p.lat;
        }

        // ç”Ÿæˆéšæœºç‚¹
        var randomLng = Math.random() * (maxLng - minLng) + minLng;
        var randomLat = Math.random() * (maxLat - minLat) + minLat;
        var randomPoint = new AMap.LngLat(randomLng, randomLat);

        // å‡ ä½•åˆ¤æ–­ï¼šç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…
        if (AMap.GeometryUtil.isPointInRing(randomPoint, path)) {
            return randomPoint;
        }
        return null;
    }

    function showResult(data) {
        var point = data.pos;
        var dist = data.dist;

        targetMarker = new AMap.Marker({
            position: point,
            animation: 'AMAP_ANIMATION_DROP',
            title: 'æ‰«è¡—ç›®çš„åœ°'
        });
        map.add(targetMarker);
        
        if (userLocation && dist > 0) {
            map.setFitView([userMarker, targetMarker], false, [50, 50, 50, 50]);
        } else {
            map.setCenter(point);
            map.setZoom(15);
        }

        var geocoder = new AMap.Geocoder();
        geocoder.getAddress(point, function(status, result) {
            var addressText = "ä½ç½®è§£æå¤±è´¥";
            if (status === 'complete' && result.regeocode) {
                addressText = result.regeocode.formattedAddress;
            }
            
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('result-address').innerText = addressText;
            document.getElementById('result-distance').innerText = dist > 0 ? Math.round(dist) : "æœªçŸ¥";
        });
    }
</script>
</body>
</html>
