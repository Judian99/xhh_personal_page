<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>ğŸ“· ç¦å·æ‘„å½±æ‰«è¡— - éšæœºé€‰ç‚¹å™¨</title>
    <style>
        html, body, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        
        .control-panel {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 340px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 999;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .panel-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* å«æ˜Ÿå›¾å¼€å…³æ ·å¼ */
        .layer-toggle {
            display: flex;
            align-items: center;
            font-size: 13px;
            background: #f3f4f6;
            padding: 6px 10px;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            margin-bottom: 15px;
            user-select: none;
        }
        .layer-toggle input {
            margin-right: 6px;
            cursor: pointer;
        }
        .layer-toggle:hover {
            background: #e5e7eb;
        }

        .section-title {
            font-size: 14px;
            color: #666;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }

        .district-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .district-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .district-item input {
            margin-right: 4px;
        }

        select, button {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            font-size: 14px;
        }

        button {
            background-color: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #1d4ed8;
        }

        button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .result-box {
            margin-top: 10px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 4px;
            border-left: 4px solid #2563eb;
            display: none;
        }

        .result-title {
            font-weight: bold;
            color: #1e40af;
            font-size: 13px;
        }
        .result-addr {
            margin-top: 4px;
            font-size: 14px;
            color: #333;
        }

        .loading-text {
            color: #666;
            font-size: 12px;
            text-align: center;
            padding: 10px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-badge {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-loading { background-color: #fbbf24; }
        .status-ready { background-color: #10b981; }
        
        @media (max-width: 480px) {
            .control-panel {
                width: calc(100% - 2rem);
                top: auto;
                bottom: 2rem;
                max-height: 60vh;
            }
        }
    </style>
</head>
<body>

<div id="container"></div>

<div class="control-panel">
    <div class="panel-header">
        <span>ğŸ“¸ æ‰«è¡—éšæœºé€‰ç‚¹</span>
        <span style="font-size:12px; font-weight:normal; color:#666;">
            <span id="data-status-dot" class="status-badge status-loading"></span>
            <span id="data-status-text">æ•°æ®åŠ è½½ä¸­...</span>
        </span>
    </div>

    <!-- å«æ˜Ÿå›¾åˆ‡æ¢å¼€å…³ -->
    <label class="layer-toggle">
        <input type="checkbox" id="satellite-checkbox" onchange="toggleSatellite()">
        ğŸ›°ï¸ å¼€å¯å«æ˜Ÿå®æ™¯å›¾
    </label>

    <div class="section-title">1. é€‰æ‹©åŒºåŸŸ (å¯è§†èŒƒå›´)</div>
    <div id="district-list" class="district-grid">
        <div class="loading-text">æ­£åœ¨è·å–è¡Œæ”¿åŒºåˆ’...</div>
    </div>

    <div class="section-title">2. è·ç¦»é™åˆ¶ (ç¦»æˆ‘å¤šè¿œ)</div>
    <select id="distance-select">
        <option value="-1">æ— é™åˆ¶ (æ‰€é€‰åŒºåŸŸå†…éšæœº)</option>
        <option value="1000">1 å…¬é‡Œå†… (æ­¥è¡Œåœˆ)</option>
        <option value="3000">3 å…¬é‡Œå†… (éª‘è¡Œåœˆ)</option>
        <option value="5000">5 å…¬é‡Œå†…</option>
        <option value="10000">10 å…¬é‡Œå†…</option>
    </select>

    <button id="locate-btn" disabled onclick="startRandomSelection()">â³ ç­‰å¾…åœ°å›¾æ•°æ®...</button>

    <div id="result-box" class="result-box">
        <div class="result-title">æ¨èåœ°ç‚¹ï¼š</div>
        <div class="result-addr" id="result-address">...</div>
        <div style="font-size:12px; color:#666; margin-top:5px;">è·æ‚¨çº¦ <span id="result-distance">-</span> ç±³</div>
    </div>
</div>

<script type="text/javascript">
    // âš ï¸âš ï¸âš ï¸ è¯·å…ˆé…ç½®å®‰å…¨å¯†é’¥ (å¿…é¡»åœ¨åŠ è½½ Key ä¹‹å‰)
    window._AMapSecurityConfig = {
        securityJsCode: '65ff073786c2bf49d673e2e8feb6b5f0', 
    }
</script>

<!-- åŠ è½½æ’ä»¶: å¢åŠ äº† AMap.DistrictLayer ç”¨äºè¡Œæ”¿åŒºæ¸²æŸ“, AMap.TileLayer.Satellite ç”¨äºå«æ˜Ÿå›¾ -->
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=43ac1e3a18e5e369343f375d3d014c4e&plugin=AMap.DistrictSearch,AMap.GeometryUtil,AMap.Geolocation,AMap.Geocoder,AMap.ToolBar,AMap.Scale,AMap.DistrictLayer,AMap.TileLayer.Satellite"></script>

<script type="text/javascript">
    // å…¨å±€å˜é‡
    var map;
    var userLocation = null; 
    var userMarker = null;
    var targetMarker = null;
    var districtLayer = null; // è¡Œæ”¿åŒºå›¾å±‚
    var satelliteLayer = null; // å«æ˜Ÿå›¾å±‚
    var districtPolygons = {}; // ç¼“å­˜è¾¹ç•Œæ•°æ® (ç”¨äºè®¡ç®—)
    var totalDistrictsToLoad = 0;
    var loadedDistrictsCount = 0;
    var selectedAdcodes = new Set(); // å½“å‰é€‰ä¸­çš„è¡Œæ”¿åŒºä»£ç 

    // åˆå§‹åŒ–
    if (typeof AMap !== 'undefined') {
        initMap();
    } else {
        alert("åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key é…ç½®");
    }

    function initMap() {
        // åˆ›å»ºåœ°å›¾
        map = new AMap.Map('container', {
            zoom: 10.5,
            center: [119.306239, 26.075302], 
            viewMode: '2D',
            resizeEnable: true,
            showLabel: true 
        });

        map.addControl(new AMap.Scale());
        map.addControl(new AMap.ToolBar({position: {top: '110px', right: '10px'}}));

        // --- 0. åˆå§‹åŒ–å«æ˜Ÿå›¾å±‚ (é»˜è®¤éšè—) ---
        satelliteLayer = new AMap.TileLayer.Satellite({
            zIndex: 1 // å«æ˜Ÿå›¾å±‚çº§è®¾ä¸º1ï¼Œä¿è¯åœ¨åº•å›¾ä¹‹ä¸Šï¼Œä½†åœ¨è¡Œæ”¿åŒºå›¾å±‚ä¹‹ä¸‹
        });
        // ä¹Ÿå¯ä»¥ map.add(satelliteLayer) ç„¶å hide()ï¼Œæˆ–è€…éœ€è¦æ—¶å† add

        // 1. åˆå§‹åŒ–è¡Œæ”¿åŒºå›¾å±‚ (DistrictLayer)
        // ä½¿ç”¨ adcode: 350100 (ç¦å·å¸‚)
        // ä¿®æ­£ï¼šä½¿ç”¨ AMap.DistrictLayer.Province æ¥åˆ›å»ºï¼Œå³ä½¿æ˜¯æ˜¾ç¤ºå¸‚çº§ä»¥ä¸‹è¡Œæ”¿åŒºä¹Ÿæ˜¯ç”¨è¿™ä¸ªç±»
        districtLayer = new AMap.DistrictLayer.Province({
            zIndex: 10, // è¡Œæ”¿åŒºå›¾å±‚å±‚çº§è®¾ä¸º10ï¼Œä¿è¯ç›–åœ¨å«æ˜Ÿå›¾ä¸Šé¢
            adcode: ['350100'],
            depth: 1, 
            styles: {
                'fill': function(properties) {
                    var adcode = properties.adcode;
                    if (selectedAdcodes.has(String(adcode))) {
                        // é€‰ä¸­æ—¶ï¼šå¦‚æœæ˜¯å«æ˜Ÿå›¾æ¨¡å¼ï¼Œé¢œè‰²å¯ä»¥ç¨å¾®æ·¡ä¸€ç‚¹ï¼Œè¿™é‡Œç»Ÿä¸€ç”¨åŠé€æ˜è“
                        return 'rgba(37, 99, 235, 0.15)'; 
                    }
                    return 'rgba(0,0,0,0)'; 
                },
                'province-stroke': 'cornflowerblue',
                'city-stroke': 'white', 
                'county-stroke': 'rgba(255,255,255,0.5)' 
            }
        });
        map.add(districtLayer);

        // 2. å®šä½
        var geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,
            timeout: 10000,
            buttonOffset: new AMap.Pixel(10, 20),
            zoomToAccuracy: false,
            buttonPosition: 'RB'
        });
        map.addControl(geolocation);
        
        geolocation.on('complete', function(data) {
            userLocation = data.position;
            if(!userMarker) {
                userMarker = new AMap.Marker({
                    position: data.position,
                    content: '<div style="background-color:blue; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 5px rgba(0,0,0,0.3);"></div>',
                    offset: new AMap.Pixel(-8, -8)
                });
                map.add(userMarker);
            } else {
                userMarker.setPosition(data.position);
            }
        });
        
        geolocation.getCurrentPosition();

        // 3. åŠ è½½è¡Œæ”¿åŒºæ•°æ®
        loadFuzhouDistricts();
    }

    // åˆ‡æ¢å«æ˜Ÿå›¾æ˜¾ç¤º
    function toggleSatellite() {
        var checkbox = document.getElementById('satellite-checkbox');
        if (checkbox.checked) {
            map.add(satelliteLayer);
        } else {
            map.remove(satelliteLayer);
        }
    }

    function loadFuzhouDistricts() {
        var districtSearch = new AMap.DistrictSearch({
            level: 'city',
            subdistrict: 1, 
            extensions: 'all' 
        });

        // æœç´¢ç¦å·å¸‚
        districtSearch.search('350100', function(status, result) {
            if(status === 'complete') {
                var subDistricts = result.districtList[0].districtList;
                var listHtml = '';
                
                totalDistrictsToLoad = subDistricts.length;
                
                subDistricts.sort((a, b) => a.adcode - b.adcode);

                subDistricts.forEach(function(district) {
                    var name = district.name;
                    var adcode = district.adcode;
                    
                    selectedAdcodes.add(String(adcode));

                    listHtml += `
                        <label class="district-item" title="${name}">
                            <input type="checkbox" name="district" value="${adcode}" checked onchange="onDistrictChange()">
                            ${name}
                        </label>
                    `;
                    loadDistrictBoundaries(adcode, name);
                });

                document.getElementById('district-list').innerHTML = listHtml;
                refreshDistrictLayer();
            } else {
                document.getElementById('district-list').innerHTML = '<div class="loading-text">è·å–è¡Œæ”¿åŒºåˆ—è¡¨å¤±è´¥</div>';
            }
        });
    }

    function onDistrictChange() {
        var checkboxes = document.querySelectorAll('input[name="district"]');
        selectedAdcodes.clear();
        checkboxes.forEach(cb => {
            if (cb.checked) {
                selectedAdcodes.add(cb.value);
            }
        });
        refreshDistrictLayer();
    }

    function refreshDistrictLayer() {
        if (!districtLayer) return;
        districtLayer.setStyles({
            'fill': function(properties) {
                var adcode = String(properties.adcode);
                return selectedAdcodes.has(adcode) ? 'rgba(37, 99, 235, 0.2)' : 'rgba(0,0,0,0)';
            },
            'county-stroke': 'rgba(100,149,237,0.5)'
        });
    }

    function loadDistrictBoundaries(adcode, name) {
        var opts = {
            subdistrict: 0, 
            extensions: 'all', 
            level: 'district'
        };
        var district = new AMap.DistrictSearch(opts);
        
        district.search(adcode, function(status, result) {
            if (status === 'complete' && result.districtList && result.districtList.length > 0) {
                var bounds = result.districtList[0].boundaries;
                if (bounds) {
                    var validBounds = bounds.filter(path => path.length > 10);
                    if (validBounds.length > 0) {
                        districtPolygons[adcode] = validBounds;
                    }
                }
            }
            loadedDistrictsCount++;
            checkDataReady();
        });
    }

    function checkDataReady() {
        if (loadedDistrictsCount >= totalDistrictsToLoad) {
            var btn = document.getElementById('locate-btn');
            btn.disabled = false;
            btn.innerText = "ğŸ² å¼€å§‹éšæœºé€‰ç‚¹";
            btn.style.backgroundColor = "#2563eb";
            
            document.getElementById('data-status-dot').className = "status-badge status-ready";
            document.getElementById('data-status-text').innerText = "åŒºåŸŸæ•°æ®å°±ç»ª";
        }
    }

    async function startRandomSelection() {
        var btn = document.getElementById('locate-btn');
        var resultBox = document.getElementById('result-box');
        
        var currentSelected = Array.from(selectedAdcodes);

        if (currentSelected.length === 0) {
            alert("è¯·è‡³å°‘åœ¨åœ°å›¾ä¸Šå‹¾é€‰ä¸€ä¸ªè¡Œæ”¿åŒºï¼");
            return;
        }

        var distanceLimit = parseInt(document.getElementById('distance-select').value);
        if (distanceLimit > 0 && !userLocation) {
            alert("âš ï¸ éœ€è¦è·å–æ‚¨çš„ä½ç½®æ‰èƒ½è®¡ç®—è·ç¦»ã€‚\nè¯·æ£€æŸ¥å®šä½æƒé™ï¼Œæˆ–è€…é€‰æ‹©'æ— é™åˆ¶'æ¨¡å¼ã€‚");
            return;
        }

        btn.disabled = true;
        btn.innerText = "æ­£åœ¨åœ°å›¾ä¸Šæœå¯»...";
        resultBox.style.display = 'none';
        if (targetMarker) map.remove(targetMarker);

        setTimeout(() => {
            var foundPoint = findValidPoint(currentSelected, distanceLimit);
            
            btn.disabled = false;
            btn.innerText = "ğŸ² å¼€å§‹éšæœºé€‰ç‚¹";

            if (foundPoint) {
                showResult(foundPoint);
            } else {
                var msg = "âš ï¸ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åœ°ç‚¹ã€‚\n\n";
                if (distanceLimit > 0) {
                    msg += "åŸå› å¯èƒ½ä¸ºï¼š\n1. æ‚¨å½“å‰è·ç¦»æ‰€é€‰çš„ã€è“è‰²åŒºåŸŸã€‘è¶…è¿‡äº† " + (distanceLimit/1000) + " å…¬é‡Œã€‚\n2. è¯·å°è¯•é€‰æ‹©ç¦»æ‚¨æ›´è¿‘çš„åŒºåŸŸï¼Œæˆ–é€‰æ‹©'æ— é™åˆ¶'ã€‚";
                } else {
                    msg += "è¯·ç¨åé‡è¯•ã€‚";
                }
                alert(msg);
            }
        }, 50); 
    }

    function findValidPoint(selectedAdcodeList, distanceLimit) {
        var maxAttempts = 800; 

        for (var i = 0; i < maxAttempts; i++) {
            var randomAdcode = selectedAdcodeList[Math.floor(Math.random() * selectedAdcodeList.length)];
            var boundaries = districtPolygons[randomAdcode];
            
            if (!boundaries || boundaries.length === 0) continue;

            var path = boundaries[Math.floor(Math.random() * boundaries.length)];
            var point = generatePointInPath(path);
            
            if (point) {
                if (distanceLimit > 0) {
                    var distance = AMap.GeometryUtil.distance(userLocation, point);
                    if (distance <= distanceLimit) {
                        return { pos: point, dist: distance };
                    }
                } else {
                    return { pos: point, dist: -1 };
                }
            }
        }
        return null;
    }

    function generatePointInPath(path) {
        var minLng = 180, maxLng = 0, minLat = 90, maxLat = 0;
        
        for(var i=0; i<path.length; i++) {
            var p = path[i];
            if(p.lng < minLng) minLng = p.lng;
            if(p.lng > maxLng) maxLng = p.lng;
            if(p.lat < minLat) minLat = p.lat;
            if(p.lat > maxLat) maxLat = p.lat;
        }

        var randomLng = Math.random() * (maxLng - minLng) + minLng;
        var randomLat = Math.random() * (maxLat - minLat) + minLat;
        var randomPoint = new AMap.LngLat(randomLng, randomLat);

        if (AMap.GeometryUtil.isPointInRing(randomPoint, path)) {
            return randomPoint;
        }
        return null;
    }

    function showResult(data) {
        var point = data.pos;
        var dist = data.dist;

        targetMarker = new AMap.Marker({
            position: point,
            animation: 'AMAP_ANIMATION_DROP',
            title: 'æ‰«è¡—ç›®çš„åœ°'
        });
        map.add(targetMarker);
        
        if (userLocation && dist > 0) {
            map.setFitView([userMarker, targetMarker], false, [80, 80, 80, 80]);
        } else {
            map.setCenter(point);
            map.setZoom(16);
        }

        var geocoder = new AMap.Geocoder();
        geocoder.getAddress(point, function(status, result) {
            var addressText = "ä½ç½®è§£æå¤±è´¥";
            if (status === 'complete' && result.regeocode) {
                addressText = result.regeocode.formattedAddress;
            }
            
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('result-address').innerText = addressText;
            document.getElementById('result-distance').innerText = dist > 0 ? Math.round(dist) : "æœªçŸ¥";
        });
    }
</script>
</body>
</html>
